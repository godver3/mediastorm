KSPlayer Dolby Vision Color Fix
================================

This patch fixes DV Profile 5 content displaying with wrong colors (green/purple tint)
when the source file has missing color metadata in stream headers.

The issue: DV Profile 5 MKV files often don't have color_primaries, color_trc, and
color_space set in the stream headers. The color info is only in the DV RPU data.
FFmpeg detects DV but reports UNSPECIFIED for color properties, which KSPlayer then
maps to sRGB (BT.709), causing wrong colors when rendering BT.2020/PQ content.

The fix: When DV is detected but color properties are unspecified, force BT.2020/PQ.

================================================================================
File: Sources/KSPlayer/MEPlayer/Resample.swift
================================================================================

Find this code (around line 128-142):

```swift
        if let pbuf {
            pbuf.aspectRatio = frame.sample_aspect_ratio.size
            pbuf.yCbCrMatrix = frame.colorspace.ycbcrMatrix
            pbuf.colorPrimaries = frame.color_primaries.colorPrimaries
            pbuf.transferFunction = frame.color_trc.transferFunction
            // vt_pixbuf_set_colorspace
            if pbuf.transferFunction == kCVImageBufferTransferFunction_UseGamma {
                let gamma = NSNumber(value: frame.color_trc == AVCOL_TRC_GAMMA22 ? 2.2 : 2.8)
                CVBufferSetAttachment(pbuf, kCVImageBufferGammaLevelKey, gamma, .shouldPropagate)
            }
            if let chroma = frame.chroma_location.chroma {
                CVBufferSetAttachment(pbuf, kCVImageBufferChromaLocationTopFieldKey, chroma, .shouldPropagate)
            }
            pbuf.colorspace = KSOptions.colorSpace(ycbcrMatrix: pbuf.yCbCrMatrix, transferFunction: pbuf.transferFunction)
        }
```

Replace with:

```swift
        if let pbuf {
            pbuf.aspectRatio = frame.sample_aspect_ratio.size
            pbuf.yCbCrMatrix = frame.colorspace.ycbcrMatrix
            pbuf.colorPrimaries = frame.color_primaries.colorPrimaries
            pbuf.transferFunction = frame.color_trc.transferFunction

            // Fix for DV Profile 5 with missing color metadata:
            // When DV is detected but color properties are unspecified (nil),
            // force BT.2020/PQ to ensure correct color rendering.
            // Without this fix, sRGB (BT.709) is assumed, causing green/purple tint.
            if isDovi && pbuf.yCbCrMatrix == nil {
                pbuf.yCbCrMatrix = kCVImageBufferYCbCrMatrix_ITU_R_2020
                pbuf.colorPrimaries = kCVImageBufferColorPrimaries_ITU_R_2020
                pbuf.transferFunction = kCVImageBufferTransferFunction_SMPTE_ST_2084_PQ
            }

            // vt_pixbuf_set_colorspace
            if pbuf.transferFunction == kCVImageBufferTransferFunction_UseGamma {
                let gamma = NSNumber(value: frame.color_trc == AVCOL_TRC_GAMMA22 ? 2.2 : 2.8)
                CVBufferSetAttachment(pbuf, kCVImageBufferGammaLevelKey, gamma, .shouldPropagate)
            }
            if let chroma = frame.chroma_location.chroma {
                CVBufferSetAttachment(pbuf, kCVImageBufferChromaLocationTopFieldKey, chroma, .shouldPropagate)
            }
            pbuf.colorspace = KSOptions.colorSpace(ycbcrMatrix: pbuf.yCbCrMatrix, transferFunction: pbuf.transferFunction)
        }
```

================================================================================
Steps to apply:
================================================================================

1. Fork KSPlayer: https://github.com/kingslay/KSPlayer
   - Go to GitHub and fork to your account (e.g., godver3/KSPlayer)

2. Clone your fork:
   git clone https://github.com/godver3/KSPlayer.git
   cd KSPlayer
   git checkout -b dv-color-fix

3. Edit Sources/KSPlayer/MEPlayer/Resample.swift and apply the change above

4. Commit and push:
   git add Sources/KSPlayer/MEPlayer/Resample.swift
   git commit -m "Fix DV Profile 5 color rendering when color metadata is missing"
   git push origin dv-color-fix

5. Update your Podfile (frontend/ios/Podfile) line 29:

   Change:
   pod 'KSPlayer', :git => 'https://github.com/kingslay/KSPlayer.git', :branch => 'main'

   To:
   pod 'KSPlayer', :git => 'https://github.com/godver3/KSPlayer.git', :branch => 'dv-color-fix'

6. Reinstall pods:
   cd frontend/ios
   pod install --repo-update

7. Rebuild and test with the DV MKV file


================================================================================
PATCH 2: Italic Text Over-Skewing Fix
================================================================================

This patch fixes italic text in subtitles appearing too heavily skewed.

The issue: ASS/SSA subtitles use \i1 (italic on) and \i0 (italic off) tags.
KSPlayer interprets the "1" directly as the NSAttributedString .obliqueness value.
An obliqueness of 1.0 is ~45 degrees skew - far too aggressive for readable text.
Standard italic slant should be around 0.12-0.2.

================================================================================
File: Sources/KSPlayer/Subtitle/KSParseProtocol.swift
================================================================================

Fix 1 - Inline italic tags (around line 204-205):

Find:
```swift
            case "i":
                attributes[.obliqueness] = scanner.scanFloat()
```

Replace with:
```swift
            case "i":
                // ASS uses \i1 for italic on, \i0 for off
                // Don't use the value directly as obliqueness (1.0 is ~45 degrees)
                // Use a reasonable italic slant of 0.15 when italic is enabled
                if let val = scanner.scanFloat(), val > 0 {
                    attributes[.obliqueness] = 0.15
                } else {
                    attributes.removeValue(forKey: .obliqueness)
                }
```

Fix 2 - Style-based italic (around line 277-278):

Find:
```swift
        if self["Italic"] == "1" {
            attributes[.obliqueness] = 1
        }
```

Replace with:
```swift
        if self["Italic"] == "1" {
            // Use reasonable italic slant (0.15) instead of 1.0 (~45 degrees)
            attributes[.obliqueness] = 0.15
        }
```
