{{template "base" .}}

{{define "title"}}Backup - mediastorm Admin{{end}}

{{define "content"}}
<div class="page-header">
    <h1>System Backup</h1>
    <p>Create, download, and restore system backups</p>
</div>

<div class="settings-group">
    <div class="group-title">Backup Management</div>

    <!-- Create Backup Section -->
    <div class="section open" id="createBackupSection">
        <div class="section-header" onclick="toggleSection(this)">
            <div class="section-title">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                Create Backup
            </div>
            <svg class="section-toggle" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"/>
            </svg>
        </div>
        <div class="section-content">
            <p class="text-muted" style="margin-bottom: 1rem;">
                Create a backup of your settings, user profiles, watchlists, and watch history. Backups do not include cached metadata (it can be regenerated).
            </p>
            <div class="backup-files-info" style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius); margin-bottom: 1rem;">
                <strong style="font-size: 0.875rem;">Files included in backup:</strong>
                <ul style="margin: 0.5rem 0 0 1.5rem; font-size: 0.875rem; color: var(--text-secondary);">
                    <li>Settings configuration</li>
                    <li>User profiles and accounts</li>
                    <li>Watchlists</li>
                    <li>Watch history and playback progress</li>
                    <li>Queue database</li>
                </ul>
            </div>
            <button class="btn btn-primary" onclick="createBackup()" id="createBackupBtn">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.5rem;">
                    <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Create Backup Now
            </button>
            <p class="text-muted" style="margin-top: 1rem; font-size: 0.875rem;">
                For automatic backups, configure a backup scheduled task in <a href="{{.BasePath}}/tools" style="color: var(--accent);">Tools > Scheduled Tasks</a>.
            </p>
        </div>
    </div>

    <!-- Backup List Section -->
    <div class="section open" id="backupListSection">
        <div class="section-header" onclick="toggleSection(this)">
            <div class="section-title">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                </svg>
                Available Backups
            </div>
            <span id="backupCountBadge" class="status-badge"></span>
            <svg class="section-toggle" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"/>
            </svg>
        </div>
        <div class="section-content">
            <!-- Loading State -->
            <div id="backupsLoading" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                <div class="spinner" style="margin: 0 auto 1rem;"></div>
                <span>Loading backups...</span>
            </div>

            <!-- Empty State -->
            <div id="backupsEmpty" style="display: none; text-align: center; padding: 2rem; color: var(--text-muted);">
                <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.5; margin-bottom: 1rem;">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                </svg>
                <p>No backups found.</p>
                <p style="font-size: 0.875rem;">Create your first backup using the button above.</p>
            </div>

            <!-- Backup List -->
            <div id="backupsList" style="display: none;">
                <!-- Backups will be rendered here -->
            </div>
        </div>
    </div>
</div>

<!-- Restore Confirmation Modal -->
<div id="restoreModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: var(--bg-elevated); padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="var(--warning)" stroke-width="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                <line x1="12" y1="9" x2="12" y2="13"/>
                <line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
            Restore Backup
        </h3>
        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
            Are you sure you want to restore from <strong id="restoreFilename"></strong>?
        </p>
        <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); padding: 1rem; border-radius: var(--radius); margin-bottom: 1rem;">
            <strong style="color: var(--warning);">Warning:</strong>
            <ul style="margin: 0.5rem 0 0 1.5rem; font-size: 0.875rem; color: var(--text-secondary);">
                <li>Current data will be replaced with backup data</li>
                <li>A pre-restore backup will be created automatically</li>
                <li>You may need to restart the server after restore</li>
            </ul>
        </div>
        <div class="btn-group" style="display: flex; gap: 0.5rem; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="hideRestoreModal()">Cancel</button>
            <button class="btn btn-danger" onclick="confirmRestore()" id="confirmRestoreBtn">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.25rem;">
                    <polyline points="1 4 1 10 7 10"/>
                    <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                </svg>
                Restore
            </button>
        </div>
    </div>
</div>

<style>
    .backup-card {
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 1rem;
        margin-bottom: 0.75rem;
    }
    .backup-card-header {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: flex-start;
        gap: 0.75rem;
    }
    .backup-info {
        flex: 1;
        min-width: 200px;
    }
    .backup-filename {
        font-weight: 500;
        font-size: 0.9375rem;
        word-break: break-all;
        font-family: monospace;
    }
    .backup-meta {
        font-size: 0.8125rem;
        color: var(--text-muted);
        margin-top: 0.25rem;
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
    }
    .backup-meta span {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    .backup-meta svg {
        width: 14px;
        height: 14px;
        opacity: 0.7;
    }
    .backup-type {
        font-size: 0.7rem;
        padding: 0.125rem 0.375rem;
        border-radius: 4px;
        text-transform: uppercase;
        font-weight: 500;
    }
    .backup-type.manual {
        background: rgba(99, 102, 241, 0.15);
        color: var(--accent);
    }
    .backup-type.scheduled {
        background: rgba(34, 197, 94, 0.15);
        color: var(--success);
    }
    .backup-type.pre_restore {
        background: rgba(245, 158, 11, 0.15);
        color: var(--warning);
    }
    .backup-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        align-items: center;
    }
    .backup-actions .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }
    @media (max-width: 480px) {
        .backup-card-header {
            flex-direction: column;
        }
        .backup-actions {
            width: 100%;
            justify-content: flex-end;
        }
    }
</style>
{{end}}

{{define "scripts"}}
<script>
    let backups = [];
    let restoreFilename = '';

    document.addEventListener('DOMContentLoaded', function() {
        loadBackups();
    });

    async function loadBackups() {
        document.getElementById('backupsLoading').style.display = 'block';
        document.getElementById('backupsEmpty').style.display = 'none';
        document.getElementById('backupsList').style.display = 'none';

        try {
            const response = await fetch('{{.BasePath}}/api/backups');
            const data = await response.json();
            backups = data.backups || [];
            renderBackups();
        } catch (err) {
            console.error('Failed to load backups:', err);
            showToast('Failed to load backups', 'error');
        } finally {
            document.getElementById('backupsLoading').style.display = 'none';
        }
    }

    function renderBackups() {
        const container = document.getElementById('backupsList');
        const badge = document.getElementById('backupCountBadge');

        if (backups.length === 0) {
            document.getElementById('backupsEmpty').style.display = 'block';
            document.getElementById('backupsList').style.display = 'none';
            badge.textContent = '0';
            badge.className = 'status-badge';
            return;
        }

        document.getElementById('backupsEmpty').style.display = 'none';
        document.getElementById('backupsList').style.display = 'block';
        badge.textContent = backups.length + ' backup' + (backups.length !== 1 ? 's' : '');
        badge.className = 'status-badge online';

        container.innerHTML = backups.map(backup => {
            const date = new Date(backup.createdAt);
            const formattedDate = date.toLocaleDateString(undefined, {
                year: 'numeric', month: 'short', day: 'numeric'
            });
            const formattedTime = date.toLocaleTimeString(undefined, {
                hour: '2-digit', minute: '2-digit'
            });
            const size = formatBytes(backup.size);
            const typeLabel = getTypeLabel(backup.type);

            return `
                <div class="backup-card">
                    <div class="backup-card-header">
                        <div class="backup-info">
                            <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                                <span class="backup-filename">${escapeHtml(backup.filename)}</span>
                                <span class="backup-type ${backup.type}">${typeLabel}</span>
                            </div>
                            <div class="backup-meta">
                                <span>
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                        <line x1="16" y1="2" x2="16" y2="6"/>
                                        <line x1="8" y1="2" x2="8" y2="6"/>
                                        <line x1="3" y1="10" x2="21" y2="10"/>
                                    </svg>
                                    ${formattedDate} at ${formattedTime}
                                </span>
                                <span>
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                        <polyline points="7 10 12 15 17 10"/>
                                        <line x1="12" y1="15" x2="12" y2="3"/>
                                    </svg>
                                    ${size}
                                </span>
                            </div>
                        </div>
                        <div class="backup-actions">
                            <button class="btn btn-secondary btn-sm" onclick="downloadBackup('${escapeHtml(backup.filename)}')" title="Download">
                                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="7 10 12 15 17 10"/>
                                    <line x1="12" y1="15" x2="12" y2="3"/>
                                </svg>
                                Download
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="showRestoreModal('${escapeHtml(backup.filename)}')" title="Restore">
                                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="1 4 1 10 7 10"/>
                                    <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                                </svg>
                                Restore
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="deleteBackup('${escapeHtml(backup.filename)}')" title="Delete" style="color: var(--danger);">
                                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"/>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                </svg>
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function getTypeLabel(type) {
        switch (type) {
            case 'manual': return 'Manual';
            case 'scheduled': return 'Scheduled';
            case 'pre_restore': return 'Pre-Restore';
            default: return type || 'Manual';
        }
    }

    function formatBytes(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    async function createBackup() {
        const btn = document.getElementById('createBackupBtn');
        const originalContent = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-small"></span> Creating backup...';

        try {
            const response = await fetch('{{.BasePath}}/api/backups', { method: 'POST' });
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Failed to create backup');
            }

            showToast('Backup created successfully', 'success');
            await loadBackups();
        } catch (err) {
            showToast(err.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalContent;
        }
    }

    function downloadBackup(filename) {
        // Trigger download via hidden link
        const link = document.createElement('a');
        link.href = '{{.BasePath}}/api/backups/' + encodeURIComponent(filename) + '/download';
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function showRestoreModal(filename) {
        restoreFilename = filename;
        document.getElementById('restoreFilename').textContent = filename;
        document.getElementById('restoreModal').style.display = 'flex';
    }

    function hideRestoreModal() {
        document.getElementById('restoreModal').style.display = 'none';
        restoreFilename = '';
    }

    async function confirmRestore() {
        if (!restoreFilename) return;

        const btn = document.getElementById('confirmRestoreBtn');
        const originalContent = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-small"></span> Restoring...';

        try {
            const response = await fetch('{{.BasePath}}/api/backups/' + encodeURIComponent(restoreFilename) + '/restore', {
                method: 'POST'
            });
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Failed to restore backup');
            }

            hideRestoreModal();
            showToast('Backup restored successfully. Please restart the server to apply all changes.', 'success');
            await loadBackups();
        } catch (err) {
            showToast(err.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalContent;
        }
    }

    async function deleteBackup(filename) {
        if (!confirm(`Delete backup "${filename}"? This cannot be undone.`)) return;

        try {
            const response = await fetch('{{.BasePath}}/api/backups/' + encodeURIComponent(filename), {
                method: 'DELETE'
            });
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Failed to delete backup');
            }

            showToast('Backup deleted', 'success');
            await loadBackups();
        } catch (err) {
            showToast(err.message, 'error');
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
{{end}}
